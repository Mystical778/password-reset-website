<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8">
  <title>Reset Password</title>
  <!-- 1. Import the Supabase JavaScript Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <h1>Reset Your Password</h1>

  <!-- This form is hidden until the user is authenticated -->
  <div id="reset-form" style="display: none;">
    <p>Enter your new password below.</p>
    <input type="password" id="password" placeholder="New Password" />
    <button onclick="updatePassword()">Save New Password</button>
  </div>

  <p id="loading-message">Please wait, validating link...</p>
  <p id="error-message" style="color: red;"></p>
  <p id="success-message" style="color: green;"></p>

  <script>
    // 2. Initialize Supabase (Use the SAME credentials as your Flutter app)
    const supabaseUrl = 'YOUR_SUPABASE_URL'; // Replace with your actual URL
    const supabaseKey = 'YOUR_SUPABASE_ANON_KEY'; // Replace with your actual anon key
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const resetForm = document.getElementById('reset-form');
    const loadingMessage = document.getElementById('loading-message');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');

    // 3. This is the crucial part: Listen for the password recovery event
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'PASSWORD_RECOVERY') {
        // If the event is correct, show the form and hide the loading text
        resetForm.style.display = 'block';
        loadingMessage.style.display = 'none';
      }
    });

    // 4. Function to handle the password update
    async function updatePassword() {
      const newPassword = document.getElementById('password').value;
      if (newPassword.length < 6) {
        errorMessage.innerText = 'Password must be at least 6 characters long.';
        return;
      }
      
      const { data, error } = await supabase.auth.updateUser({ password: newPassword });

      if (error) {
        errorMessage.innerText = 'Error: ' + error.message;
      } else {
        resetForm.style.display = 'none';
        successMessage.innerText = 'Success! Your password has been updated. You can now close this window and log in on your mobile app.';
      }
    }
  </script>

</body>
</html>